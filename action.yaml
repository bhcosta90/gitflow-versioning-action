name: "Gitflow Versioning"
description: "Gerencia versões no estilo Git Flow com incremento automático de tags e atualização do CHANGELOG."
author: "bhcosta90"

inputs:
  mode:
    description: "Modo de execução (dev, dev-branch, release-branch, finalize-package, finalize-release)"
    required: true
  branch:
    description: "Nome da branch base (opcional, usado em dev-branch e release-branch)"
    required: false
  changelog_entry:
    description: "Notas para o CHANGELOG.md (usado no finalize-package)"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Executar GitFlow
      shell: bash
      run: |
        set -e

        echo "Modo selecionado: ${{ inputs.mode }}"

        case "${{ inputs.mode }}" in

        dev)
          # Incrementa dev-x.y.z na branch develop
          latest=$(git tag --list "dev-*" --sort=-v:refname | head -n 1)
          if [[ -z "$latest" ]]; then
            version="dev-0.0.0"
          else
            base=${latest#dev-}
            IFS='.' read -r major minor patch <<< "$base"
            patch=$((patch+1))
            version="dev-$major.$minor.$patch"
          fi
          echo "Criando tag: $version"
          git tag $version
          git push origin $version
          ;;

        dev-branch)
          # Incremento patch em develop/x.y
          base="${{ inputs.branch }}"
          latest=$(git tag --list "${base}.*" --sort=-v:refname | head -n 1)
          if [[ -z "$latest" ]]; then
            version="${base}.0"
          else
            patch=${latest##*.}
            patch=$((patch+1))
            version="${base}.${patch}"
          fi
          echo "Criando tag: $version"
          git tag $version
          git push origin $version
          ;;

        release-branch)
          # Incremento patch em release/x.y
          base="${{ inputs.branch }}"
          latest=$(git tag --list "${base}.*" --sort=-v:refname | head -n 1)
          if [[ -z "$latest" ]]; then
            version="${base}.0"
          else
            patch=${latest##*.}
            patch=$((patch+1))
            version="${base}.${patch}"
          fi
          echo "Criando tag: $version"
          git tag $version
          git push origin $version
          ;;

        finalize-package)
          # Pega última dev tag
          latest=$(git tag --list "dev-*" --sort=-v:refname | head -n 1)
          if [[ -z "$latest" ]]; then
            echo "Nenhuma dev tag encontrada."
            exit 1
          fi

          version=${latest#dev-}
          echo "Tag final: $version"

          # Atualizar CHANGELOG.md se input fornecido
          if [[ -n "${{ inputs.changelog_entry }}" ]]; then
            echo "## $version ($(date +'%Y-%m-%d'))" >> CHANGELOG.md
            echo "${{ inputs.changelog_entry }}" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add CHANGELOG.md
            git commit -m "docs: atualizar CHANGELOG.md para $version"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi

          # Criar a tag final
          git tag $version
          git push origin $version

          # Criar branch develop/x.y
          major_minor=$(echo $version | cut -d'.' -f1,2)
          git checkout -b develop/$major_minor
          git push origin develop/$major_minor

          # Apagar dev tags
          for tag in $(git tag --list "dev-*"); do
            git push --delete origin "$tag"
            git tag -d "$tag"
          done
          ;;

        finalize-release)
            latest=$(git tag --list "[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
            if [[ -z "$latest" ]]; then
              echo "Nenhuma tag final encontrada."
              exit 1
            fi
            major_minor=$(echo $latest | cut -d'.' -f1,2)
            git checkout -b release/$major_minor
            git push origin release/$major_minor
            for tag in $(git tag --list "dev-*"); do
              git push --delete origin "$tag"
              git tag -d "$tag"
            done
            for branch in $(git branch -r | grep "origin/develop/" | sed 's/origin\///'); do
              git push origin --delete "$branch"
            done
            ;;
        esac
